var keys=["name","filter"];function selectDestType(e){if(!e.value)return $(".dest-value").addClass("hidden");var t="#"+e.value+"Input";$(t).removeClass("hidden").siblings(".dest-value").addClass("hidden")}function selectRuleList(e){$.post(window.location.href,{pageId:e,op:"ruleList"},function(e){if(e.Code!=1){return App.message({title:App.i18n.SYS_INFO,text:e.Info,class_name:"error"})}var t="",a=$("#tmpl-field-settings").html();for(var n=0;n<e.Data.length;n++){var l=e.Data[n],i=a;for(var r=0;r<keys.length;r++){var o=keys[r],p=new RegExp("{="+o+"=}","g");if(o=="filter"){i=i.replace(p,"")}else{i=i.replace(p,l[o])}}t+=i}$("#export-field-settings").html(t);attachSearchCollectField()},"json");return true}function selectPageRule(e){var t=$(e).attr("id");var r=$(e).val();if(t=="pageRoot"){if(r<1){$("#pageId").html('<option value="0">'+App.t("请选择")+"</option>");return true}$.post(window.location.href,{pageId:r,op:"childrenPageList"},function(e){if(e.Code!=1){return App.message({title:App.i18n.SYS_INFO,text:e.Info,class_name:"error"})}var t="",a=2;for(var n=0;n<e.Data.length;n++){var l=e.Data[n];if(!l.name)l.name=App.t("%d级页面",n+a);t+='<option value="'+l.id+'">'+l.name+"</option>"}t='<option value="'+r+'">'+App.t("顶级页面")+"</option>"+t;$("#pageId").html(t);var i=$("#pageId").val()*1;if(i>0)r=i;selectRuleList(r)},"json");return true}if(!r)return $("#export-field-settings").empty();return selectRuleList(r)}function addRow(e){var t=$("#tmpl-field-settings").html();for(var a=0;a<keys.length;a++){var n=keys[a],l=new RegExp("{="+n+"=}","g");t=t.replace(l,"")}if(e==null){$("#export-field-settings").prepend(t)}else{$(e).parent().parent().after(t)}attachSearchCollectField()}function delRow(e){$(e).parent().parent().remove()}function moveUpRow(e){var t=$(e).parent().parent();if(t.prev("tr").length>0){t.prev("tr").before(t.clone());t.remove()}}function moveDownRow(e){var t=$(e).parent().parent();if(t.next("tr").length>0){t.next("tr").after(t.clone());t.remove()}}function attachSearchCollectField(){$("#export-field-settings").find('input[name="mapping[name][]"]').not(".tt-input").each(function(){searchCollectField(this)})}function searchCollectField(e,t){if(t==null)t=500;$(e).typeahead({hint:true,highlight:true,minLength:1},{source:function(e,t,a){var n=$("#pageId").val();$.ajax({url:window.location.href,type:"post",data:{pageId:n,op:"ruleList"},dataType:"json",async:false,success:function(e){var a=[];if(!e.Data)return;$.each(e.Data,function(e,t){a.push(t.name)});t(a)}})},limit:t})}var filterInput=null;function showFilterModal(e){var t=$(e).parent(".input-group-btn");filterInput=t.siblings("input:first");$("#filter-modal").niftyModal("show")}$(function(){if($("#destType").val())selectDestType($("#destType")[0]);attachSearchCollectField();$("#filter-modal").find(".modal-body").html($("#filter-list-tmpl").html());$("#filter-modal").on("click","a[data-placeholder]",function(){var e=filterInput.val(),t=$(this).data("placeholder");if(e)t=e+"|"+t;filterInput.val(t);$("#filter-modal").niftyModal("hide");filterInput.focus()})});