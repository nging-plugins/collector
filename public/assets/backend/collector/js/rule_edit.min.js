function addRule(e,t){var r=$("#rule-tmpl").html();if(t)r=r.replace(/ name\="rule\[/g,' name="extra[rule]['+t+"][");r=r.replace(/\{\=idx\=\}/g,t||"");$(e).parents("div.form-group").after(r)}function removeRule(e){var t=$(e).parents("div.form-group");var r=t.find('[name$="[rule][]"]').text();var a=t.find('[name$="[var][]"]').val();var l=t.find('[name$="[filter][]"]').val();if(r||a||l){if(!confirm(App.t("确定要删除规则吗？")))return}t.remove()}function removePage(e){if(!confirm(App.t("确定要删除页面规则吗？")))return;$("#extra-page-"+e).remove()}function addPage(e){var t=$("hr.extra-page").length,r=$("#page-tmpl").html().replace(/\{\=idx\=\}/g,t);$(e).parents("div.form-group").before('<div class="extra-page-container" id="extra-page-'+t+'"><a href="javascript:;" class="label label-danger extra-page-remove" onclick="removePage('+t+');" data-toggle="tooltip" title="'+App.t("删除页面规则")+'"><i class="fa fa-times"></i></a>'+r+"</div>")}function verifyRule(t){var e="",r=$(t).val();var a=function(){if(!$(t).hasClass("parsley-error"))return;$(t).removeClass("parsley-error");if($(t).next("ul.parsley-errors-list").length>0)$(t).next("ul.parsley-errors-list").remove()};if(!r||r.length<9)return a();if(r.substring(0,7)=="regexp:"){e="regexp";r=r.substring(7)}else if(r.substring(0,8)=="regexp2:"){e="regexp2";r=r.substring(8)}else{return a()}var l={type:e,regexp:r};$.post(BACKEND_URL+"/collector/regexp_test",l,function(e){if(!e.Error)return a();if(!$(t).hasClass("parsley-error"))$(t).addClass("parsley-error");if($(t).next("ul.parsley-errors-list").length<1)$(t).after('<ul class="parsley-errors-list"></ul>');$(t).next("ul.parsley-errors-list").html('<li class="required" style="display:list-item">'+App.t("正则表达式错误")+": "+e.Error+"</li>");$(t).focus()},"json")}function showRegexpTester(t){var r=$("#regexp-test-modal").find(".modal-body"),a="";var l=$(t).val();if(!l||l.length<9)return;if(l.substring(0,7)=="regexp:"){a="regexp";l=l.substring(7)}else if(l.substring(0,8)=="regexp2:"){a="regexp2";l=l.substring(8)}else{return}var i=function(){$("#regexp-test-modal").niftyModal("show",{afterOpen:function(e){$(window).trigger("resize");r.find('[name="regexp"]').val(l);r.find('[name="type"][value="'+a+'"]').prop("checked",true)},afterClose:function(e){$(t).val(r.find('[name="type"]:checked').val()+":"+r.find('[name="regexp"]').val())}})};if(!r.data("ready")){$.get(BACKEND_URL+"/collector/regexp_test",{type:a},function(e){r.html(e);r.data("ready",true);i()},"html")}else{i()}}var filterInput=null;function showFilterModal(e){filterInput=$(e).parent(".input-group-btn").siblings("input:first");$("#filter-modal").niftyModal("show")}$(function(){$("#filter-modal").find(".modal-body").html($("#filter-list-tmpl").html());$("#filter-modal").on("click","a[data-placeholder]",function(){var e=filterInput.val();if(e){filterInput.val(e+"|"+$(this).data("placeholder"))}else{filterInput.val($(this).data("placeholder"))}$("#filter-modal").niftyModal("hide");filterInput.focus()});$(window).on("resize",function(){$("#regexp-test-modal").css({height:$(window).height(),width:"100%","max-width":"100%",left:0,top:0,transform:"none","z-index":"9999"});$("#regexp-test-form").css({height:$(window).height()-180,overflow:"auto"})});$("#regexp-test-modal .modal-footer .btn-default.md-close:last").html('<i class="fa fa-times"></i> '+App.t("关闭"));var e=$("#regexp-test-modal .modal-footer .btn-primary:last");e.html('<i class="fa fa-stethoscope"></i> '+App.t("测试"));e.removeClass("md-close").click(function(){var i=$("#regexp-test-form");App.loading("show");$.post(BACKEND_URL+"/collector/regexp_test",i.serialize(),function(e){App.loading("hide");if(e.Error)return App.message({text:e.Error},false);if(!e.Result){i.find(".result tbody").empty();return App.message({text:App.t("没有匹配到任何结果"),type:"warning"})}var t="";for(var r=0;r<e.Result.length;r++){var a=e.Result[r];t+="<tr>";t+="<td>"+r+"</td>";t+='<td><table class="table table-bordered no-margin"><thead><tr><th style="width:50px">'+App.t("编号")+"</th><th>"+App.t("结果")+"</th></tr></thead><tbody>";for(var l=0;l<a.length;l++){t+="<tr>";t+="<td>"+l+"</td>";t+="<td>"+App.htmlEncode(a[l])+"</td>";t+="</tr>"}t+="</tbody></table></td>";t+="</tr>"}i.find(".result tbody").html(t)},"json")});$("#collector-rule-form").on("submit",function(e){e.preventDefault();var t=$(this);$.post(t.attr("action"),t.serialize(),function(e){if(e.Code==1){App.message({text:e.Info,class_name:"success",after_open:function(e){window.location=BACKEND_URL+"/collector/rule"}});return}if(e.Zone){t.find('[name="'+e.Zone+'"]').focus()}App.message({text:e.Info,class_name:"danger"})},"json")})});